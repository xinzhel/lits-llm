"""RAP-specific data structures.

This module contains data structures specific to the RAP (Reasoning via Planning)
formulation, including the SubQAStep for sub-question decomposition.
"""

from dataclasses import dataclass
from typing import List
from lits.structures.base import Step, ActionT, StringAction
from lits.type_registry import register_type


@register_type
@dataclass
class SubQAStep(Step):
    """RAP-style sub-question step capturing the decomposition state.
    
    Represents a single step in the RAP reasoning process where a complex
    question is decomposed into sub-questions that are answered sequentially.
    
    Attributes:
        sub_question: The sub-question generated by the policy
        sub_answer: The answer to the sub-question from the transition
        confidence: Self-consistency confidence score (0.0 to 1.0)
    """

    sub_question: StringAction = ""
    sub_answer: str = ""
    confidence: float = 0.0

    def get_action(self) -> ActionT:
        return self.sub_question

    def get_answer(self) -> str:
        return self.sub_answer

    def verb_step(self) -> str:
        """Return a string representation of the sub-question and answer."""
        return f"Sub-question: {self.sub_question}\nSub-answer: {self.sub_answer}"

    def to_dict(self) -> dict:
        """Serialize the step including RAP-specific fields."""
        data = super().to_dict()
        data["sub_question"] = self.sub_question
        data["sub_answer"] = self.sub_answer
        data["confidence"] = self.confidence
        return data

    @classmethod
    def from_dict(cls, data: dict) -> "SubQAStep":
        """Deserialize from dict."""
        return cls(
            error=data.get("error"),
            terminate=data.get("terminate", False),
            sub_question=data.get("sub_question", ""),
            sub_answer=data.get("sub_answer", ""),
            confidence=data.get("confidence", 0.0),
        )

    def to_messages(self) -> list[dict]:
        """Convert the step into chat messages (assistant asks, then answers)."""
        return [
            {"role": "assistant", "content": f"Sub-question: {self.sub_question}"},
            {"role": "assistant", "content": f"Sub-answer: {self.sub_answer}"}
        ]
    
    @classmethod
    def verbalize_state(cls, question: str, state: List["SubQAStep"], n_shots: int = 4) -> str:
        """Verbalize RAP state into a prompt string for answer extraction.
        
        Delegates to verbalize_rap_state for consistency with existing code.
        
        Args:
            question: The original question being decomposed
            state: List of SubQAStep representing current decomposition state
            n_shots: Number of few-shot examples (affects indexing)
        
        Returns:
            Formatted string for LLM prompt
        """
        from .utils import verbalize_rap_state
        return verbalize_rap_state(question, state, n_shots)
